# 稳定性

## 怎么衡量系统稳定性？
一般来讲，通过统计系统不可用的时长或次数就可以对稳定性进行量化，比如业内常说 4 个 9 的可用性（即 1 年内 99.99% 的时间系统是可用的，不可用时长仅为 52.6 分钟）。



针对稳定性的提高也可以看作围绕事故的治理，可以从事故发生的前、中、后分阶段来看对应的关键点。

- 事故的类型：可用性事故、资损类事故。
- 事故前预防：主动治理减少系统的风险隐患，重点在变更管控、可用性设计、应急预案与演练。
- 事故中应急：“止血、恢复”是原则。
- 事故后复盘：目的不是追责，查根因、改进架构、完善应急、总结经验才是我们想要的。

## 事故的类型

从事故特性上看，我们可以分为可用性事故和资损类事故。

可用性事故：技术原因导致系统部分或者全部功能不可用，业务没办法正常完成对应流程或者提供对应服务。比如因为网络、DB、接口 Bug 等原因，用户没办法登录、商品列表不显示等。

资损类事故： 系统的功能都能正常使用，但因为逻辑、计算等原因让业务的某一方产生了资金损失。比如用户支付一律为 0 元、错发 999 无门槛优惠券、商户清结算少打款给商户等等。

## 故障处理的生命周期

> 故障处理的生命周期，可以分为 4 个阶段：发现异常、排查问题、判断决策、恢复处理。这 4 个阶段对应的行动并不是完全串行的，虽然有一定的依赖关系，但在实际的处理过程中应该并行展开。类似 fork/join 的模式，不断完成小任务、不断汇总信息，不断做出判断与决策，形成循环直到故障恢复。

### 1. 故障发现

![故障发现](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/CgqCHmAJMdeAc_F6AAJTrBjwTWE310-20210527163509208.png)



总的来说，人工的被动反馈在时间和速度上有较强的不确定性，很容易出现“小故障 * 长时间 = 大事故”的情形。而纯粹的技术指标监控又会忽略掉接口正常响应，但是业务异常的场景，只有两者结合，通过监控告警，最大程度上缩短故障感知的时间，才能早发现早解决，减少业务影响。

### 2. 故障排查

- 直接锁定：最近的变更点与异常现象间有直接的逻辑关联，进而可以直接锁定到故障点。比如，刚对下单接口进行了发布变更，接口的 QPS 曲线就暴跌，可以基本断定是刚才的发布导致。

- 排除法：当干扰因素过多（用户、订单等几个系统同时发生变更，引起订单下跌），很难直接锁定到故障点，就要结合业务场景，让整条架构链路上的所有关联方进行自查自证，通过排除法锁定故障。

### 3. 故障决策

业务决策非常复杂，能否第一时间止损很大程度上取决于技术 Leader 的现场反应和操作， 要注意故障决策的两个关键点 ：

一定要有明确的决策人、主导者和有效的沟通方式（钉钉群、多人电话会议、紧急作战会议室等），让信息可以通畅地交流出来，并且决策人可以根据情况做判断与取舍，形成所有人明确的处理结论。 比如，第一时间停止错误红包的发放，确保故障没有增量，并把决策第一时间同步给团队成员，并同步相关负责人后续的动作，对已发放的红包，明确要求负责人汇总各类关键信息（红包数量、涉及金额、涉及用户数、有效时长、可能资损等）。

所有的信息一定要数据化，不同的数据量级会导致决策不同，比如红包错发 50W 可能只是暂停发放，但是存量红包依然可以核销，损失公司可以承担。但是如果错发 5000W，大概就要涉及一系列的调整，这是非常影响决策的。

### 4. 故障恢复

> 应急“三板斧”：变更回滚、服务重启、降级&限流。

![故障恢复](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/Cip5yGAJMf2AFDdiAAJOfl-EHu8036.png)

## 如何有价值地做事后复盘？

你可以从时长、现象、处理时间轴、根因、改进计划这几个维度进行复盘， 在以下几个方面进行深究：

事故时长：1-5-10(即 1 分钟发现、5 分钟响应、10 分钟恢复) 是否达成，如果没有是为什么？哪个环节用时最多，如何提高和改善？

事故根因：根因不等于直接原因，一个事故的直接原因往往并不复杂，但是根因可能是多个维度的缺失，需要像剥洋葱一样一层层找下去。拿库存接口变更这个Case来说，直接原因就是某段代码逻辑变更导致，但是应该在测试、发布、监控、应急影响、预案设计等多个环节展开去看，根因的挖掘并不忌讳“吹

毛求疵”。

事故改进措施：由点推到面、明确到人、明确时间。与根因类似，要结合多个维度形成组合拳的改进点，避免一次性动作，要将重点放在对未来、对同类问题的预防上。核心就是如果再一次发生类似的问题，这些改进措施是不是能起到作用。

关于事后复盘，你可以这样理解，我们要深挖事故如何发生的、如何处理的、未来怎么预防。但要避免情绪化，在复盘会上的反思、感悟、懊恼没有任何意义，如何带领团队把精力放在改进措施的落实以及事故前的治理上更有价值， 另外，你需要留出时间让团队伙伴进行内部的 Review，避免为了开会而复盘。

> 没有质量的交付，再多再快都毫无意义。

![稳定性](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/CgqCHmAJMo-Ae8JIAAI6Da3tjL0715.png)

## 变更会引起90%以上的故障

### 1. 变更需要监控

有效的监控要回答三个问题：

是否有问题发生？

哪里发生了问题？

发生了什么问题？

### 2. 有效灰度必须有耐心

> 灰度从来不是为了测试，也不等于 A/B Test。它本身是为了对抗“未知的不确定性”。

要想实现灰度的有效性，关键点在于时间和流量。

时间：每个灰度阶段至少有 5 ~ 10 min 的观察，在监控、日志和各方反馈没有异常后再扩大灰度范围，确保一些运行时异常或量变积累质变的问题可以暴露出来。

流量：有时一些业务场景需要特定的触发条件，比如满足某些条件的用户或满足某些条件的订单，那么在灰度时就不能仅通过单位时间内有没有异常来判断，还要确保有足够的有效流量。

### 3. 回滚就是变更的“后悔药”

要知道，系统并不是天然可以无缝回滚的，想要系统具备回滚的能力，在设计与实现阶段需要付出额外的精力。可回滚的本质是系统的兼容性设计与实现，比如常见的“只增不改”，一个 API 内要调整很多实现逻辑才能满足新业务的需求，此时不妨直接新增一个 API ，两个 API 保持参数一致，那么一旦新 API 有异常直接切换回旧的 API 即可。

所以，不论是灰度计划还是回滚策略都应该在架构设计阶段就去考虑，结合排期、风险程度、成本投入这些方面，要做好评估与平衡。



## 坚守 Design For Failure 的架构理念

“Design for failure and nothing will fail”，最早是 AWS 的一条最佳实践，即`面向失败进行系统设计`。可以理解为：考虑系统所有可能发生故障或不可用的情形，并假设这些可能都会发生，倒逼自己设计足够健壮的系统。

### 1. 将经验教训沉淀下来

历史是最好的老师，我建议你总结并分析过去发生过的事故，并结合常规分布式系统的可用性风险，以此梳理出一个围绕事故隐患的风险点 Checklist，在需求迭代或者架构设计时，通过它高效地找到系统实现的薄弱环节。

除了完善 Checklist，在团队普及这种设计理念之外，更关键的是将这些解决方案沉淀成设计原则，让研发人员可以在实际中落地。

### 2. 通过演练验证预案设计

设计并实现了自己的故障演练系统，日常主动制造事故上下文来验证我们的设计与系统是否可靠。

## 把稳定性当作机制与文化去建设

系统稳定性结果好坏很大程度上取决于技术 Leader 的重视程度，如果一个团队的管理者都不能身体力行的去重视它，而仅仅只是喊喊口号，那就不要指望团队成员能认真地对待这件事。

### 1. 新人 Landing 从稳定性学习开始

### 2. 每人不低于 35% 的稳定性 KPI

### 3. 好的坏的都要在阳光之下晒一晒

![可用性治理与预防](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/Cip5yGAOnceAK51TAAEbIVsowNo778.png)

## 建立资损概念的宏观认知

从广义上来看，存在理论损失也应该算资损， 比如因为搜索推荐系统出问题（不论什么原因）导致这一阶段广告的收入减少，或者因系统 Bug 导致用户取消订单的申请被默认同意（虽然原本商户可能也会做同意处理，但是申诉的话平台依然要赔付），类似预计收益减少或者因系统问题产生赔付的场景都应算为资损。

![资损定义和分类](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/CgpVE2ASYyyAAp99AAHQPeoXQkg893.png)

## 资损防控的三个关键

### 1. 防：资金视角做风险点识别

![资损风险点识别](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/CgpVE2ASY0OAILA7AAE89CbKGfA505.png)

### 2. 监：一致性与正确性双核对

针对资损感知的核心思想是：基于线上业务结果收拢进行监控，基于线下业务场景扩散进行核对。

与可用性监控围绕接口的技术指标不同，资损更关注的是数据核对，监控的并不是运行状态而是运行结果，并且资损监控的粒度要求非常高，精细到每一笔交易、每一次金额计算、每一个红包发放。所以资损监控的有效性很依赖于场景的覆盖率，仅覆盖几个关键场景是不足以规避资损风险的，除了要定期梳理外，每次系统有变更或者新功能时，都需检查是否有新的核对点，以及旧有核对公式是否需要调整。

![资损监控核对](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/CgpVE2ASY1aARH-TAAHJrR1s-W0317.png)

### 3. 控：资金拦截 + 资产控制

除了防和监，资损防控的关键主要在“控”字上，我们希望在问题发生后第一时间止损，这就需要技术在系统层面对资金和资产有很强的控制能力。这种能力的表现就是： 不仅可以通过预案将某些场景与链路降级，还可以拦截资金的流出和资产的使用，同时具备快速订正错误数据的能力。

在我们开始处理资损事故时，会有三个共性的需求。

问题止血不新增：核心是关闭问题产生源头，往往通过业务场景降级来实现，比如对错误红包或者满减活动进行下线。

控制资金流出：核心是对资金和资产进行拦截与冻结，避免外流后损失无法修正，比如禁止用户下单时勾选使用有问题的红包。

存量数据订正：核心是捞取问题数据后可以快速地批量处理，比如批量更改红包的金额、甚至直接将红包无效。

虽然其中一些操作对用户体验是有损的，但有而不用是一回事儿，无能为力则是另外一回事儿，其中：

资金拦截的能力主要从资金的流入和流出这两端进行把控。以红包而言就是管控其创建与核销。在红包创建时，有预算系统进行管控，避免无限制地生成红包进而超发。在红包核销时，由交易和营销系统进行验证，确保订单上下文以及红包合法，避免问题红包被核销进而造成无法挽回的资损。

资产管控的能力则是资产的快速锁定和数据订正展开，以红包而言，如果不同模版不同活动的红包都有一个统一的批次号，就可以通过这个标记快速捞取某一批有问题的数据。同时如果提前准备批量订正的脚本，或者有订正数据的平台，就可以快速修改红包金额、使用时间、使用门槛等关键信息，甚至批量无效所有问题红包。

你需要注意，这些能力的实现更多依赖于技术 Leader 在日常需求迭代和架构设计时，是否有意识引导团队加强这方面的建设。大部分的预案思路来源于过去已经发生的问题，或者对未来可能发生问题的假设，将预案常态化是你重点关注并推进落地的。

除了建设预案，还要有预案演练，以此保证预案的有效性。技术 Leader 更应该鼓励测试和开发的同学主动做攻防演练，寻找漏洞、验证止损方案、及时发现并修复问题。

![资源预案止损](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/Cip5yGASY2aAan_KAAHwX7CkMbQ394.png)





![](/Users/wangzetao/Work/github/ReadingNotes/%E6%88%90%E4%B8%BA%E4%BC%9A%E5%B8%A6%E5%9B%A2%E9%98%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BA%BA/%E6%8A%80%E6%9C%AF%E4%BA%BA%E4%B8%89%E8%A6%81%E7%B4%A0/CgpVE2ASY3WAF33QAAE50Zm97VM138.png)











# 技术债务

·